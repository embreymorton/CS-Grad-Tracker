#!/usr/bin/env node
// workaround something broken with jsdom, which mongoose depends on:
const util = require('util')
global.TextDecoder = util.TextDecoder
global.TextEncoder = util.TextEncoder
var mongoose = require('mongoose')
mongoose.Promise = require('bluebird')

require('../env').load()

var app = require('../app.js')

global.server = {}

/*
Once a connection with the database has been secured, start the app
on host:port
*/
console.log('Starting server in ' + process.env.mode + ' mode...')
mongoose.connect(process.env.databaseString)
mongoose.connection
  .on('error', console.error.bind(console, 'connection error:'))
  .once('open', function () {
    console.log("App running at " + process.env.host + ":" + process.env.port)
    global.server = app.listen(process.env.port, process.env.host)
    process.on('uncaughtException', async (err) => {
      console.error(err)
      console.error("Backend process crashed! :(")
      if (process.env.mode == 'development') {
        try {
          nodemailer = require('nodemailer')
          const testAccount = {user: "retta.doyle50@ethereal.email", pass: "J7PWfjJ4FewKyAQhRj"}
          const response = await nodemailer.createTransport({
            host: "smtp.ethereal.email",
            port: 587,
            auth: {
              user: testAccount.user,
              pass: testAccount.pass
            }
          }).sendMail({to: "kekevi@live.unc.edu", subject: "CS-GradTracking has crashed!", text: `you are really putting yourself on call... Crashed at ${new Date()}`}).catch(
            () => console.log("This is awkward... The email to notify developers that the server has crashed failed to send."))
          console.log("It's okay ðŸ˜Ž, we've just alerted the devlopers here: " + nodemailer.getTestMessageUrl(response))
        } catch (e) {
          console.error("omg the error catcher just threw an error too...", e)
        }
      }
      process.exit(1)
    })
  })
